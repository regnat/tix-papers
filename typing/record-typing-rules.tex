% TODO: Those rules can't really be used for typechecking because of the unary
% records.
% They should either be rewritten with n-ary records or we should accept a
% dummy top-down typing for records.
\begin{figure}
  \newcommand{\onerec}{\{..\}}
  \begin{mathpar}
    \inferrule{%
      Γ \vdash e' : τ \\
    Γ \vdash e : \bigvee\limits_{i=1}^n s_i
    }{%
      Γ \vdash \left\{ e = e'; \right\} :
    \bigvee\limits_{i=1}^n \left\{ s_i = τ \right\}
    }\lbl{RFinite}

    \and\inferrule{%
      Γ \vdash e' : τ \\
    Γ \vdash e : σ \\
    σ \subtype \text{String}
    }{%
      Γ \vdash \left\{ e = e'; \right\} :
    \left\{ \_ = τ \vee \undefr \right\}
    }\lbl{RInfinite}

    \and\inferrule{%
      Γ \vdash e_1 : \tau \\ Γ \vdash e_2 : σ \\
    \tau \subtype \onerec{} \\
    σ \subtype \onerec{} \\
    \domr_\undefr(\tau) \cap \domr_\undefr(σ) = \varnothing
    }{%
      Γ \vdash e_1 \orthmerge e_2 : \tau \orthmerge σ
    }\lbl{ROrthMerge}
    \and\inferrule{%
      Γ \vdash e_1 : \tau \\ Γ \vdash e_2 : σ \\
    \tau \subtype \onerec{} \\
    σ \subtype \onerec{}
    }{%
      Γ \vdash e_1 + e_2 : \tau + σ
    }\lbl{RMerge}

    \and\inferrule{%
      Γ \vdash e_1 : τ \\
      Γ \vdash e_2 : \bigvee\limits_{i=1}^n s_i \\
      τ \subtypeG \onerec \\
      \bigvee\limits_{i=1}^n τ(s_i) \wedge \undefr \subtype \Empty
    }{%
      Γ \vdash e_1 . e_2 : \bigvee\limits_{i=1}^n τ(s_i)
    }\lbl{RAccess}

    \and\inferrule{%
      Γ \vdash e_1 : τ \\
      Γ \vdash e_2 : \bigvee\limits_{i=1}^n s_i \\
      Γ \vdash e_3 : σ
    }{%
      Γ \vdash e_1 . e_2 \text{ or } e_3 :
      \left( \bigvee\limits_{i=1}^n τ(s_i) \backslash \undefr \right) \vee σ
    }\lbl{RGuardedAccessFinite}

    \and\inferrule{%
      Γ \vdash e_1 : τ \\ Γ \vdash e_2 : τ' \\
      τ' \subtype \text{string} \\
      Γ \vdash e_3 : σ
    }{%
      Γ \vdash e_1 . e_2 \text{ or } e_3 :
      \left( \defr(τ) \vee
        \bigvee\limits_{s \in \dom(τ)} τ(s) \backslash \undefr \right)
        \vee σ
    }\lbl{RGuardedAccessInfinite}
  \end{mathpar}
  \caption{Typing rules for records\label{typing::records}}
\end{figure}
